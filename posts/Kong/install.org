#+TITLE: Kong - 安装
#+DATE: 2023-09-27 22:24:42
#+DISPLAY: t
#+STARTUP: indent
#+OPTIONS: toc:10
#+AUTHOR: inmove
#+KEYWORDS: API网关 Kong
#+CATEGORIES: API网关

* 在Docker中安装
#+begin_src yaml
  version: '3.9'

  services:
    #######################################
    # Postgres: Kong Database
    #######################################
    kong-db:
      image: postgres:12-alpine
      container_name: kong-db
      networks:
        - kong-net
      environment:
        POSTGRES_DB: kong
        POSTGRES_USER: kong
        POSTGRES_PASSWORD: kong
      healthcheck:
        test: ["CMD", "pg_isready", "-U", "kong"]
        interval: 10s
        timeout: 5s
        retries: 5
      restart: on-failure
    #######################################
    # Kong database migration
    #######################################
    kong-migrations:
      image: kong-with-hello-world:latest
      command: "kong migrations bootstrap""
      container_name: kong-migrations
      networks:
        - kong-net
      depends_on:
        kong-db:
          condition: service_healthy
      environment:
        KONG_DATABASE: postgres
        KONG_PG_HOST: kong-db
        KONG_PG_DATABASE: kong
        KONG_PG_USER: kong
        KONG_PG_PASSWORD: kong
      restart: on-failure
    #######################################
    # Kong: The API Gateway
    #######################################
    kong-ce:
      # image: kong:3.3
      image: kong-with-hello-world:latest
      container_name: kong
      networks:
        - kong-net
      restart: on-failure
      depends_on:
        kong-db:
          condition: service_healthy
      environment:
        KONG_DATABASE: postgres
        KONG_PG_HOST: kong-db
        KONG_PG_DATABASE: kong
        KONG_PG_USER: kong
        KONG_PG_PASSWORD: kong
        KONG_ADMIN_LISTEN: 8001
        KONG_PROXY_LISTEN: 0.0.0.0:8000, 0.0.0.0:8443 http2 ssl
        KONG_LUA_PACKAGE_PATH: ./?.lua;./?/init.lua
        KONG_PROXY_ACCESS_LOG: /dev/stdout
        KONG_ADMIN_ACCESS_LOG: /dev/stdout
        KONG_PROXY_ERROR_LOG: /dev/stderr
        KONG_ADMIN_ERROR_LOG: /dev/stderr
        KONG_LOG_LEVEL: info
      ports:
        - "80:8000"
        - "443:8443"
        - "8001:8001"

  networks:
    kong-net:
      external: true
#+end_src
