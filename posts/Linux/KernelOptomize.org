#+TITLE: Nginx 内核参数调优
#+DATE: 2023-09-30 00:24:06
#+DISPLAY: t
#+STARTUP: indent
#+OPTIONS: toc:10
#+AUTHOR: inmove
#+KEYWORDS: LinuxKernelOptimize
#+CATEGORIES: Linux

* For Web
#+begin_src conf
  # 单个worker能同时打开的最大文件描述符数
  # 它限制了最大并发连接数。10000表示最大并发数为5000
  fs.file-max = 10000

  # 允许TIME-WAIT状态的socket重用
  net.ipv4.tcp_tw_reuse = 1

  # 当开始检测时，如果 tcp_keepalive_probes 次检测都没有收到因应，连接就被认为是死掉了
  # 当tcp连接处于空闲状态多久后，进行存活检测。默认是2小时
  net.ipv4.tcp_keepalive_time = 600
  # 设置发送探针的次数
  net.ipv4.tcp.tcp_keepalive_probes = 5
  # 两次探针发送的时间间隔
  net.ipv4.tcp.tcp_keepalive_intvl = 75

  # 当服务器主动关闭连接时，socket保持FIN-WAIT-2状态的最大时间
  net.ipv4.tcp_fin_timeout = 30

  # 操作系统允许的TIME_WAAIT状态的socket最大值
  net.ipv4.ip_max_tw_buckets = 5000

  # UDP和TCP连接中本地端口的取值范围
  net.ipv4.ip_local_port_range = 1024 61000

  # TCP接收缓存(用于TCP接收滑动窗口)的最小值，默认值，最大值，
  net.ipv4.tcp_rmem = 4096 32768 262142
  # TCP发送缓存(用于TCP发送滑动窗口)的最小值，默认值，最大值，
  net.ipv4.tcp_wmem = 4096 32768 262142

  # 当网卡接收数据包的速度大于内核处理速度时，会有一个Queue保存这个数据包
  # 这个参数表示这个Queue的最大值
  net.core.netdev_max_backlog = 4096

  # 每个连接都会维护滑动窗口而消耗内存，所以这个缓存区大小也与并发连接数有关
  # 内核socket接收缓存区默认大小
  net.core.rmem_default = 262144
  # 内核socket发送缓存区默认大小
  net.core.wmem_default = 262144
  # 内核socket接收缓存区最大大小
  net.core.rmem_max = 2097152
  # 内核socket发送缓存区最大大小
  net.core.wmem_max = 2097152

  # 主要用于解决 TCP 的 SYN 洪水攻击
  # SYN cookies 机制通过不为每个接收到的 SYN 请求分配完整的资源来防止洪水攻击。它会根据接收到的 SYN 请求生成一个特殊的 cookie，并在 SYN-ACK 响应中将其发送回客户端，而不是分配资源来追踪连接。只有当客户端以正确的 cookie 响应时，服务器才会分配资源来建立连接。
  net.ipv4.tcp_syncookies = 1

  # TCP二次握手建立阶段接收SYN请求Queue的最大长度。默认为1024
  # 设置大一点可以提高接受连接的数量。但是如果太大又会存在过多的SYN的连接数。
  net.ipv4.tcp_max_syn.backlog = 1024
#+end_src
